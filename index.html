<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Anivers√°rios PWA</title>
    
    <!-- Meta tags do PWA -->
    <meta name="theme-color" content="#546e7a"/>
    <meta name="description" content="Um PWA simples para listar anivers√°rios, com suporte offline.">

    <!-- Link para o Manifesto-->
    <link rel="manifest" href="manifest.json">
    
    <!-- Pico.css CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 0px; 
        }
        [data-theme="light"] {
            --primary: #546e7a;
            --primary-hover: #455a64;
            --primary-focus: rgba(84, 110, 122, 0.25);
            --primary-inverse: #FFF;
        }
        h1, h2 { color: var(--primary); }
        #birthday-list article {
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        #birthday-list .info { flex-grow: 1; }
        #birthday-list .info strong { font-size: 1.1rem; color: var(--primary); }
        #birthday-list .actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .btn-edit {
            --pico-background-color: #ffc107;
            --pico-border-color: #ffc107;
            --pico-color: #000;
        }
        .btn-delete {
            --pico-background-color: #dc3545;
            --pico-border-color: #dc3545;
        }
        #message-box {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            background-color: var(--primary);
            color: var(--primary-inverse);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: bottom 0.5s ease-in-out;
            z-index: 1000;
            opacity: 0;
        }
        #message-box.show { bottom: 20px; opacity: 1; }
    </style>
</head>
<body data-theme="light">

    <!-- Conte√∫do Principal-->
    <main class="container">
        
        <!-- Cabe√ßalho -->
        <header>
            <h1><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16" style="vertical-align: -4px; margin-right: 8px;">
                <path d="M4.5 1A.5.5 0 0 1 5 1.5v.664a.5.5 0 0 1-.092.287l-1.87 2.137A.5.5 0 0 1 2.5 4.5v.393c0 .326.164.624.432.793l1.813 1.106A.5.5 0 0 1 5 7.188V13.5a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1.278l-.068-.028-1.918 1.37A.5.5 0 0 1 .5 13V.5a.5.5 0 0 1 .5-.5h3.5zm10 0a.5.5 0 0 1 .5.5v12.5a.5.5 0 0 1-.5.5h-3.5a.5.5 0 0 1-.408-.213l-1.918-1.37-.068.028V13.5a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5V7.188a.5.5 0 0 1 .255-.438l1.813-1.106c.268-.17.432-.467.432-.793v-.393a.5.5 0 0 1-.541-.499l-1.87-2.137A.5.5 0 0 1 11 1.5V1.5a.5.5 0 0 1 .5-.5h3.5z"/>
              </svg>Lista de Anivers√°rios üéâ</h1>
            <p>Adicione, edite e veja os anivers√°rios.</p>
        </header>

        <!-- Formul√°rio -->
        <article data-theme="light">
            <form id="birthday-form">
                <input type="hidden" id="entry-id">
                <div class="grid">
                    <label for="nome">
                        Nome
                        <input type="text" id="nome" name="nome" placeholder="Nome do aniversariante" required>
                    </label>
                    <label for="data">
                        Data
                        <input type="date" id="data" name="data" required>
                    </label>
                </div>
                <div class="grid">
                    <button type="submit" id="btn-save">Salvar</button>
                    <button type="button" id="btn-clear" class="secondary outline">Limpar</button>
                </div>
            </form>
        </article>

        <!-- Lista -->
        <section>
            <h2>Aniversariantes</h2>
            <div id="birthday-list">
                <article id="loading-state">
                    <p aria-busy="true">Carregando aniversariantes...</p>
                </article>
            </div>
        </section>

    </main>
    
    <!-- Caixa de Mensagem -->
    <div id="message-box"></div>
    <!-- Script Principal -->
    <script type="module">
        /*
         * Classe BirthdayDB
         * Encapsula toda a l√≥gica de intera√ß√£o com o IndexedDB.
         */
        class BirthdayDB {
            constructor(dbName = 'BirthdayDB', storeName = 'birthdays') {
                this.dbName = dbName;
                this.storeName = storeName;
                this.db = null;
            }

            open() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('IndexedDB aberto com sucesso.');
                        resolve(this.db);
                    };
                    request.onerror = (event) => {
                        console.error('Erro ao abrir IndexedDB:', event.target.error);
                        reject(event.target.error);
                    };
                });
            }

            _getTransaction(mode) {
                if (!this.db) {
                    throw new Error("DB n√£o est√° aberto. Chame open() primeiro.");
                }
                const transaction = this.db.transaction(this.storeName, mode);
                return transaction.objectStore(this.storeName);
            }

            save(item) {
                return new Promise((resolve, reject) => {
                    if (item.id) {
                        item.id = parseInt(item.id, 10);
                    }
                    const store = this._getTransaction('readwrite');
                    const request = store.put(item); 
                    request.onsuccess = (event) => {
                        resolve(event.target.result);
                    };
                    request.onerror = (event) => {
                        console.error('‚ùå Erro ao salvar item:', event.target.error);
                        reject(event.target.error);
                    };
                });
            }

            getAll() {
                return new Promise((resolve, reject) => {
                    const store = this._getTransaction('readonly');
                    const request = store.getAll();
                    request.onsuccess = (event) => {
                        resolve(event.target.result);
                    };
                    request.onerror = (event) => {
                        console.error('‚ùå Erro ao buscar todos os itens:', event.target.error);
                        reject(event.target.error);
                    };
                });
            }

            delete(id) {
                return new Promise((resolve, reject) => {
                    const store = this._getTransaction('readwrite');
                    const request = store.delete(parseInt(id, 10));
                    request.onsuccess = () => {
                        resolve();
                    };
                    request.onerror = (event) => {
                        console.error('‚ùåErro ao deletar item:', event.target.error);
                        reject(event.target.error);
                    };
                });
            }
        }

        /**
         * Classe AppUI
         * Encapsula toda a l√≥gica de intera√ß√£o com o DOM.
         */
        class AppUI {
            constructor(db) {
                this.db = db;
                this.form = document.getElementById('birthday-form');
                this.listContainer = document.getElementById('birthday-list');
                this.loadingState = document.getElementById('loading-state');
                this.messageBox = document.getElementById('message-box');
                this.fieldId = document.getElementById('entry-id');
                this.fieldName = document.getElementById('nome');
                this.fieldDate = document.getElementById('data');
                this.btnClear = document.getElementById('btn-clear');
                this.messageTimer = null;
            }

            async init() {
                try {
                    await this.db.open();
                    this.registerEventListeners();
                    this.loadBirthdayList();
                } catch (error) {
                    console.error("Falha ao inicializar o AppUI:", error);
                    this.loadingState.innerHTML = "<p> ‚ùåErro ao carregar o banco de dados.</p>";
                }
            }

            registerEventListeners() {
                this.form.addEventListener('submit', (e) => this.handleFormSubmit(e));
                this.btnClear.addEventListener('click', () => this.clearForm());
                
                this.listContainer.addEventListener('click', (e) => {
                    const target = e.target;
                    if (target.classList.contains('btn-edit')) {
                        const id = target.closest('article').dataset.id;
                        this.handleEditClick(id);
                    }
                    if (target.classList.contains('btn-delete')) {
                        const id = target.closest('article').dataset.id;
                        this.handleDeleteClick(id);
                    }
                });
            }

            async loadBirthdayList() {
                try {
                    const items = await this.db.getAll();
                    this.renderList(items);
                } catch (error) {
                    console.error("Erro ao carregar lista:", error);
                    this.listContainer.innerHTML = "<p>N√£o foi poss√≠vel carregar a lista.</p>";
                }
            }

            formatDate(isoDate) {
                if (!isoDate) return 'Data inv√°lida';
                const [year, month, day] = isoDate.split('-');
                return `${day}/${month}/${year}`;
            }

            renderList(items) {
                this.loadingState.style.display = 'none';
                
                if (items.length === 0) {
                    this.listContainer.innerHTML = '<p>Nenhum anivers√°rio cadastrado ainda.</p>';
                    return;
                }

                items.sort((a, b) => a.data.localeCompare(b.data));
                this.listContainer.innerHTML = ''; 

                items.forEach(item => {
                    const article = document.createElement('article');
                    article.dataset.id = item.id;
                    
                    article.innerHTML = `
                        <div class="info">
                            <strong>${item.nome}</strong><br>
                            <small>${this.formatDate(item.data)}</small>
                        </div>
                        <div class="actions">
                            <button class="btn-edit secondary" data-id="${item.id}">Editar üñä</button>
                            <button class="btn-delete contrast" data-id="${item.id}">Excluir üóëÔ∏è </button>
                        </div>
                    `;
                    this.listContainer.appendChild(article);
                });
            }

            async handleFormSubmit(event) {
                event.preventDefault();
                const entry = {
                    nome: this.fieldName.value,
                    data: this.fieldDate.value
                };
                const id = this.fieldId.value;
                if (id) {
                    entry.id = id;
                }
                
                try {
                    await this.db.save(entry);
                    this.showMessage(id ? 'Anivers√°rio atualizado! ' : 'Anivers√°rio salvo!');
                    this.clearForm();
                    this.loadBirthdayList();
                } catch (error) {
                    console.error("‚ùå Erro ao salvar:", error);
                    this.showMessage(' Erro ao salvar. Tente novamente.', 'error');
                }
            }

            async handleEditClick(id) {
                try {
                    const items = await this.db.getAll(); 
                    const item = items.find(i => i.id === parseInt(id, 10));
                    if (item) {
                        this.fieldId.value = item.id;
                        this.fieldName.value = item.nome;
                        this.fieldDate.value = item.data;
                        this.fieldName.focus();
                    }
                } catch (error) {
                    console.error("‚ùå Erro ao carregar para edi√ß√£o:", error);
                }
            }

            async handleDeleteClick(id) {
                try {
                    await this.db.delete(id);
                    this.showMessage('Anivers√°rio exclu√≠do.');
                    this.loadBirthdayList();
                    this.clearForm();
                } catch (error) {
                    console.error("‚ùå Erro ao deletar:", error);
                    this.showMessage('‚ùå Erro ao excluir.', 'error');
                }
            }

            clearForm() {
                this.form.reset();
                this.fieldId.value = '';
            }
            
            showMessage(message) {
                if (this.messageTimer) {
                    clearTimeout(this.messageTimer);
                }
                this.messageBox.textContent = message;
                this.messageBox.classList.add('show');
                this.messageTimer = setTimeout(() => {
                    this.messageBox.classList.remove('show');
                }, 3000);
            }
        }


        /*
         * registra o arquivo sw.js.
         */
        function registerPWA() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    // Registra o Service Worker a partir do arquivo
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => {
                            console.log('Service Worker registrado com sucesso! Escopo:', registration.scope);
                        })
                        .catch(error => {
                            console.error('Falha ao registrar Service Worker:', error);
                        });
                });
            } else {
                console.warn('Service Worker n√£o √© suportado neste navegador.');
            }
        }
        
        // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO ---
        // Registra o Service Worker
        registerPWA();

        // Aguarda o DOM estar pronto para iniciar a UI
        document.addEventListener('DOMContentLoaded', () => {
            const db = new BirthdayDB();
            const ui = new AppUI(db);
            ui.init();
        });

    </script>
</body>
</html>